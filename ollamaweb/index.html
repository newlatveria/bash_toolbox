
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Pro UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f3f4f6; font-family: system-ui, -apple-system, sans-serif; }
        .chat-bubble { max-width: 80%; padding: 10px 16px; border-radius: 12px; margin-bottom: 10px; line-height: 1.5; white-space: pre-wrap; }
        .user-msg { background-color: #4f46e5; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .ai-msg { background-color: #ffffff; color: #1f2937; align-self: flex-start; margin-right: auto; border: 1px solid #e5e7eb; border-bottom-left-radius: 2px; }
        .stat-badge { background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 99px; font-size: 0.75rem; font-weight: 600; }
        /* Scrollbar style */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-white border-b px-6 py-3 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 text-white p-2 rounded-lg">
                <i class="fa-solid fa-robot"></i>
            </div>
            <h1 class="font-bold text-gray-800 text-lg">Ollama<span class="text-indigo-600">Pro</span></h1>
            <span id="status-indicator" class="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-500">Checking...</span>
        </div>
        <div class="flex items-center gap-4">
            <select id="model-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2">
                <option value="">Loading models...</option>
            </select>
            <button onclick="openManageModal()" class="text-gray-500 hover:text-indigo-600"><i class="fa-solid fa-gear"></i></button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 flex flex-col" id="chat-container">
        <div class="m-auto text-center text-gray-400">
            <i class="fa-solid fa-comments text-4xl mb-3"></i>
            <p>Select a model and start chatting.</p>
        </div>
    </main>

    <div id="context-bar" class="px-6 py-2 bg-gray-50 border-t text-xs flex justify-between items-center hidden">
        <div class="flex items-center gap-2 text-gray-600">
            <span id="perf-tps" class="stat-badge hidden">0 t/s</span>
            <span id="perf-time" class="stat-badge hidden">0s</span>
            <span id="perf-device" class="hidden font-bold text-orange-600" title="Likely CPU"><i class="fa-solid fa-microchip"></i> CPU</span>
            <span id="perf-device-gpu" class="hidden font-bold text-green-600" title="Likely GPU"><i class="fa-solid fa-bolt"></i> GPU</span>
        </div>
        <div id="active-files" class="flex gap-2"></div>
    </div>

    <footer class="bg-white p-4 border-t">
        <div class="flex justify-between items-center mb-2">
            <div class="flex gap-2">
                <button onclick="saveSession()" class="text-gray-500 hover:text-indigo-600 text-xs font-medium flex items-center gap-1 bg-gray-100 px-2 py-1 rounded">
                    <i class="fa-solid fa-download"></i> Save
                </button>
                <label class="cursor-pointer text-gray-500 hover:text-indigo-600 text-xs font-medium flex items-center gap-1 bg-gray-100 px-2 py-1 rounded">
                    <i class="fa-solid fa-upload"></i> Load
                    <input type="file" id="session-upload" class="hidden" accept=".json" onchange="loadSession(this)">
                </label>
                <button onclick="clearChat()" class="text-red-400 hover:text-red-600 text-xs font-medium ml-2">
                    <i class="fa-solid fa-trash"></i> Clear
                </button>
            </div>
            <label class="cursor-pointer text-indigo-600 hover:text-indigo-800 text-sm font-semibold flex items-center gap-1">
                <i class="fa-solid fa-paperclip"></i> Add File
                <input type="file" id="context-upload" class="hidden" onchange="uploadContextFile(this)">
            </label>
        </div>

        <div class="relative">
            <textarea id="user-input" rows="1" class="block w-full p-4 pr-12 text-sm text-gray-900 bg-gray-50 rounded-xl border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500 resize-none overflow-hidden" placeholder="Type your message... (Shift+Enter for new line)"></textarea>
            <button id="send-btn" class="absolute right-2 bottom-2.5 bg-indigo-600 text-white rounded-lg p-2 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
        <div class="text-center mt-2">
            <span id="thinking-msg" class="text-xs text-indigo-500 hidden"><i class="fa-solid fa-circle-notch fa-spin"></i> Thinking...</span>
        </div>
    </footer>

    <div id="manage-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-96 p-6">
            <h2 class="text-lg font-bold mb-4">Model Management</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Pull Model</label>
                <div class="flex gap-2">
                    <input type="text" id="pull-name" placeholder="e.g. llama2" class="flex-1 border rounded px-2 py-1 text-sm">
                    <button onclick="performAction('pull')" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Pull</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Delete Model</label>
                <div class="flex gap-2">
                    <select id="delete-select" class="flex-1 border rounded px-2 py-1 text-sm"></select>
                    <button onclick="performAction('delete')" class="bg-red-600 text-white px-3 py-1 rounded text-sm">Del</button>
                </div>
            </div>
            
            <div id="action-log" class="bg-gray-100 p-2 rounded text-xs h-20 overflow-y-auto mb-4 font-mono"></div>

            <button onclick="document.getElementById('manage-modal').classList.add('hidden')" class="w-full border border-gray-300 py-2 rounded text-sm hover:bg-gray-50">Close</button>
        </div>
    </div>

    <script>
        // --- State ---
        let chatHistory = []; // Stores {role, content}
        let fileContexts = []; // Stores {name, content} temporary for next message
        const TPS_GPU_THRESHOLD = 10.0; // Arbitrary: >10 t/s usually implies GPU on average hardware

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchModels();
            // Auto-resize textarea
            const tx = document.getElementById('user-input');
            tx.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                if(this.value === '') this.style.height = 'auto';
            });
            // Enter key
            tx.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            document.getElementById('send-btn').addEventListener('click', sendMessage);
        });

        // --- API Interactions ---
        async function fetchModels() {
            const indicator = document.getElementById('status-indicator');
            try {
                const res = await fetch('/api/models');
                if(!res.ok) throw new Error('Failed');
                const data = await res.json();
                
                indicator.textContent = "Ollama Online";
                indicator.className = "text-xs px-2 py-1 rounded-full bg-green-100 text-green-700";

                const sel = document.getElementById('model-select');
                const delSel = document.getElementById('delete-select');
                sel.innerHTML = ''; delSel.innerHTML = '';

                if(data.models) {
                    data.models.forEach(m => {
                        sel.add(new Option(m.name, m.name));
                        delSel.add(new Option(m.name, m.name));
                    });
                }
            } catch (e) {
                indicator.textContent = "Ollama Offline";
                indicator.className = "text-xs px-2 py-1 rounded-full bg-red-100 text-red-700";
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const btn = document.getElementById('send-btn');
            const model = document.getElementById('model-select').value;
            
            let text = input.value.trim();
            
            // Append File Contexts if any
            if (fileContexts.length > 0) {
                let fileSection = "\n\n--- ATTACHED FILES ---\n";
                fileContexts.forEach(f => {
                    fileSection += "FILE: " + f.name + "\nCONTENT:\n" + f.content + "\n\n";
                });
                fileSection += "--- END FILES ---\n";
                text += fileSection;
                // Clear contexts after sending
                fileContexts = [];
                document.getElementById('active-files').innerHTML = '';
            }

            if (!text || !model) return;

            // UI Updates
            appendMessage('user', text);
            input.value = '';
            input.style.height = 'auto';
            btn.disabled = true;
            document.getElementById('thinking-msg').classList.remove('hidden');
            document.getElementById('context-bar').classList.add('hidden'); // Hide old stats

            // Prepare Chat History for API
            const messagesForApi = chatHistory.map(m => ({ role: m.role, content: m.content }));

            // Start Assistant Bubble
            const assistantBubble = appendMessage('assistant', '');
            let fullResponse = "";

            try {
                const res = await fetch('/api/ollama', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        actionType: 'chat', 
                        model: model, 
                        messages: messagesForApi 
                    })
                });

                const reader = res.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6);
                            try {
                                const data = JSON.parse(jsonStr);
                                
                                // Streaming Text
                                if (data.message && data.message.content) {
                                    fullResponse += data.message.content;
                                    assistantBubble.textContent = fullResponse;
                                    scrollToBottom();
                                }

                                // Statistics (Final Chunk)
                                if (data.done) {
                                    chatHistory.push({ role: 'assistant', content: fullResponse });
                                    updateStats(data);
                                }
                            } catch (e) { /* Ignore non-JSON lines or partial lines */ }
                        }
                    }
                }
            } catch (err) {
                // Remove the last user message from history if the request failed completely
                chatHistory.pop(); 
                assistantBubble.className += " ai-msg bg-red-100 text-red-700";
                assistantBubble.textContent = "[Error] Failed to connect or receive response from Ollama: " + err.message;
            } finally {
                btn.disabled = false;
                document.getElementById('thinking-msg').classList.add('hidden');
            }
        }

        // --- Features Logic ---

        // 1. Message Rendering
        function appendMessage(role, text) {
            const container = document.getElementById('chat-container');
            
            // Remove placeholder if exists
            if (container.querySelector('.text-gray-400')) {
                container.innerHTML = '';
            }

            const div = document.createElement('div');
            div.className = "chat-bubble " + (role === 'user' ? 'user-msg' : 'ai-msg');
            div.textContent = text;
            container.appendChild(div);
            scrollToBottom();

            if (role === 'user') {
                chatHistory.push({ role: 'user', content: text });
            }
            return div;
        }

        function scrollToBottom() {
            const c = document.getElementById('chat-container');
            c.scrollTop = c.scrollHeight;
        }

        // 2. Stats & GPU/CPU Detection
        function updateStats(data) {
            const bar = document.getElementById('context-bar');
            const tpsEl = document.getElementById('perf-tps');
            const timeEl = document.getElementById('perf-time');
            const cpuBadge = document.getElementById('perf-device');
            const gpuBadge = document.getElementById('perf-device-gpu');

            if (!data.eval_count || !data.eval_duration) return;

            // Math: eval_duration is nanoseconds
            const seconds = data.eval_duration / 1e9;
            const tps = data.eval_count / seconds;

            tpsEl.textContent = tps.toFixed(1) + " t/s";
            timeEl.textContent = (data.total_duration / 1e9).toFixed(1) + "s";
            
            tpsEl.classList.remove('hidden');
            timeEl.classList.remove('hidden');
            bar.classList.remove('hidden');

            // Heuristic for GPU detection
            if (tps > TPS_GPU_THRESHOLD) {
                gpuBadge.classList.remove('hidden');
                cpuBadge.classList.add('hidden');
            } else {
                gpuBadge.classList.add('hidden');
                cpuBadge.classList.remove('hidden');
            }
        }

        // 3. File Upload (Context)
        function uploadContextFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                fileContexts.push({
                    name: file.name,
                    content: e.target.result
                });
                
                // Render visual tag
                const tag = document.createElement('span');
                tag.className = "bg-indigo-100 text-indigo-700 px-2 py-1 rounded border border-indigo-200 text-xs";
                tag.innerHTML = '<i class="fa-solid fa-file"></i> ' + file.name;
                document.getElementById('active-files').appendChild(tag);
                document.getElementById('context-bar').classList.remove('hidden');
            };
            reader.readAsText(file); // Assumption: Text based files
            input.value = '';
        }

        // 4. Session Management (Save/Load)
        function saveSession() {
            if (chatHistory.length === 0) return alert("No chat to save");
            const blob = new Blob([JSON.stringify(chatHistory, null, 2)], {type : 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'ollama-session-' + new Date().toISOString().slice(0,10) + '.json';
            a.click();
        }

        function loadSession(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const hist = JSON.parse(e.target.result);
                    if (Array.isArray(hist)) {
                        
                        // Clear current view
                        document.getElementById('chat-container').innerHTML = '';
                        chatHistory = []; 

                        // Re-render
                        hist.forEach(msg => {
                            // Render visually without adding back to chatHistory, as we set it below
                            const container = document.getElementById('chat-container');
                            const div = document.createElement('div');
                            div.className = "chat-bubble " + (msg.role === 'user' ? 'user-msg' : 'ai-msg');
                            div.textContent = msg.content;
                            container.appendChild(div);
                        });
                        chatHistory = hist; // Restore memory
                        scrollToBottom();
                        alert("Session loaded successfully!");
                    } else {
                        alert("Invalid session file format.");
                    }
                } catch(err) { 
                    alert("Error parsing session file: " + err.message); 
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function clearChat() {
            if(!confirm("Are you sure you want to clear the chat history?")) return;
            chatHistory = [];
            fileContexts = [];
            document.getElementById('chat-container').innerHTML = '<div class="m-auto text-center text-gray-400"><i class="fa-solid fa-comments text-4xl mb-3"></i><p>Select a model and start chatting.</p></div>';
            document.getElementById('context-bar').classList.add('hidden');
            document.getElementById('active-files').innerHTML = '';
        }

        // 5. Model Management
        function openManageModal() {
            document.getElementById('manage-modal').classList.remove('hidden');
            // Ensure delete list is up to date
            fetchModels(); 
            document.getElementById('action-log').innerText = '';
        }

        async function performAction(type) {
            const log = document.getElementById('action-log');
            let modelName = "";
            
            if (type === 'pull') modelName = document.getElementById('pull-name').value;
            if (type === 'delete') modelName = document.getElementById('delete-select').value;

            if (!modelName) return;

            log.innerText += "> " + type.toUpperCase() + " " + modelName + "...\n";
            log.scrollTop = log.scrollHeight;
            
            try {
                const res = await fetch('/api/ollama', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ actionType: type, model: modelName })
                });
                const txt = await res.text();
                log.innerText += "Success: " + txt + "\n";
                log.scrollTop = log.scrollHeight;
                fetchModels(); // Refresh lists
            } catch (e) {
                log.innerText += "Error: " + e.message + "\n";
                log.scrollTop = log.scrollHeight;
            }
        }
    </script>
</body>
</html>

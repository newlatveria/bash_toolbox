#!/bin/bash

# Define the target location and filename
TARGET_DIR="/usr/local/bin"
SCRIPT_NAME="admin_rescue.sh"
TARGET_PATH="$TARGET_DIR/$SCRIPT_NAME"

# Colors
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
CYAN='\033[1;36m'
STD='\033[0m'

# Check for Root
if [ "$EUID" -ne 0 ]; then
  echo -e "${RED}Error: Please run this installer with sudo.${STD}"
  echo "Usage: sudo ./install_admin_tool.sh"
  exit 1
fi

echo -e "${CYAN}--- System Admin & Rescue Tool Installer ---${STD}"

# Check if the script already exists
if [ -f "$TARGET_PATH" ]; then
  echo -e "${YELLOW}Warning: The script already exists at $TARGET_PATH.${STD}"
  read -r -p "Do you want to [O]verwrite it or [A]bort? (O/A): " choice
  choice=${choice^^} # Convert to uppercase
  
  if [[ "$choice" == "A" ]]; then
    echo -e "${GREEN}Installation aborted. You can run the existing tool by typing: ${CYAN}$SCRIPT_NAME${STD}"
    exit 0
  fi
  
  echo -e "${YELLOW}Overwriting existing script...${STD}"
fi

echo -e "${GREEN}Installing SAERT (v19.0 - Graphics Repair Edition) to $TARGET_PATH...${STD}"

# Write the entire main script content (v19.0) to the target path using a here document.
cat > "$TARGET_PATH" << 'EOF_SCRIPT'
#!/bin/bash

# ==========================================================
# ðŸš€ SYSTEM ADMIN & EMERGENCY RESCUE TOOL
# Version: 19.0 (Graphics/Driver Repair Edition)
# Description: Admin Dashboard with Headless/TTY Rescue capabilities.
# ==========================================================

# --- Terminal Layout ---
printf '\033[8;45;110t'

# --- Colors ---
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
STD='\033[0m' 

# Vars
SAI="sudo apt install -y "
lastmessage="Welcome to the Desktop Admin Console."
MODEL_PATH="/var/lib/ollama/models"
OVERRIDE_FILE="/etc/systemd/system/ollama.service.d/override.conf"

# Podman variables (must be global)
loadproject="" 
containername="" 
PodName="" 
thisfile="" 


# --- Utility Functions ---

pause(){
  echo ""
  read -r -p "  Press [Enter] to continue..."
}

# --- HEADER (Dashboard) ---

DrawHeader(){
    clear
    LocalIP=$(hostname -I | awk '{print $1}')
    Distro=$(grep PRETTY_NAME /etc/os-release | cut -d'"' -f2)
    Kernel=$(uname -r)
    CPULoad=$(awk '{print $1}' /proc/loadavg 2>/dev/null)
    
    # Memory Usage
    MemTotal=$(awk '/MemTotal/{printf "%.0f", $2/1024}' /proc/meminfo 2>/dev/null)
    MemUsed=$(awk '/MemTotal/{T=$2}/MemFree/{F=$2}/Buffers/{B=$2}/Cached/{C=$2} END {printf "%.0f", (T-F-B-C)/1024}' /proc/meminfo 2>/dev/null)
    if command -v bc &> /dev/null && [ "$MemTotal" -gt 0 ] 2>/dev/null; then
        MemPercent=$(echo "scale=0; ($MemUsed * 100) / $MemTotal" | bc 2>/dev/null)
    else
        MemPercent="?"
    fi
    
    # Banner
    echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${STD}"
    echo -e "${BLUE}â•‘${STD} ${WHITE}SYSTEM ADMIN & RESCUE DASHBOARD${STD}                                                            ${BLUE}â•‘${STD}"
    echo -e "${BLUE}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${STD}"
    printf "${BLUE}â•‘${STD} ${CYAN}%-14s${STD} : %-30s ${CYAN}%-14s${STD} : %-30s ${BLUE}â•‘${STD}\n" "OS Distro" "$Distro" "Local IP" "$LocalIP"
    printf "${BLUE}â•‘${STD} ${CYAN}%-14s${STD} : %-30s ${CYAN}%-14s${STD} : %-30s ${BLUE}â•‘${STD}\n" "Kernel" "$Kernel" "Time" "$(date "+%H:%M:%S")"
    echo -e "${BLUE}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${STD}"
    printf "${BLUE}â•‘${STD} ${GREEN}%-14s${STD} : %-30s ${MAGENTA}%-14s${STD} : %-30s ${BLUE}â•‘${STD}\n" "CPU Load" "$CPULoad (1min)" "Memory Used" "$MemUsed/${MemTotal}MB (${MemPercent}%)"
    echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${STD}"
}

# -----------------------------------------------------------
# ðŸ› ï¸ MAINTENANCE & INSTALLATION 
# -----------------------------------------------------------

InstallCoreTools(){
    echo -e "${CYAN}--- Installing All Core & Rescue Tools (v19.0) ---${STD}"
    echo "This ensures all dependencies for Rescue (GUI & Headless), Admin, and Podman are installed."

    # Packages needed for full functionality
    CORE_PACKAGES="htop neofetch ncdu timeshift testdisk boot-repair radeontop mc curl git speedtest-cli"
    # ubuntu-drivers-common is crucial for the graphics rescue menu
    RESCUE_PACKAGES="ubuntu-drivers-common network-manager"
    PODMAN_PACKAGES="podman containers-storage podman-docker docker-compose"
    APT_TOOLS="bc software-properties-common"

    sudo apt update
    $SAI $APT_TOOLS
    sudo add-apt-repository ppa:yannubuntu/boot-repair -y
    $SAI $CORE_PACKAGES $RESCUE_PACKAGES $PODMAN_PACKAGES
    
    # Enable Podman Socket
    if command -v systemctl &> /dev/null; then
        sudo systemctl enable --now podman.socket
    fi
    
    lastmessage="${GREEN}All tools installed. Graphics Repair Ready.${STD}"
}

SystemUpdates(){
    sudo apt update && sudo apt upgrade -y
    sudo apt autoremove -y
    lastmessage="System updated and cleaned."
}

DiskAnalyzer(){
    if ! command -v ncdu &> /dev/null; then echo -e "${RED}ncdu not installed.${STD}"; pause; return 1; fi
    ncdu /
    pause
}

SnapshotManager(){
    if ! command -v timeshift &> /dev/null; then echo -e "${RED}Timeshift not installed.${STD}"; pause; return 1; fi
    sudo timeshift-gtk
    lastmessage="Launched Timeshift Snapshot Manager."
}

NetworkSpeed(){
    if ! command -v speedtest-cli &> /dev/null; then echo -e "${RED}speedtest-cli not installed.${STD}"; pause; return 1; fi
    echo -e "${GREEN}Running Network Speed Test...${STD}"
    /usr/bin/speedtest-cli --simple
    pause
}

# -----------------------------------------------------------
# ðŸš¨ EMERGENCY RESCUE ROOM
# -----------------------------------------------------------

GuidedRescue(){
    echo -e "${CYAN}--- Starting Auto-Diagnostic & Repair ---${STD}"
    echo -e "\n${YELLOW}STEP 1/4: Fixing Package System...${STD}"
    sudo dpkg --configure -a
    sudo apt --fix-broken install -y
    sudo apt update
    echo -e "\n${YELLOW}STEP 2/4: Fixing Boot Menu (GRUB)...${STD}"
    sudo update-grub
    echo -e "\n${YELLOW}STEP 3/4: Scheduling Disk Repair (fsck)...${STD}"
    sudo touch /forcefsck
    echo -e "\n${YELLOW}STEP 4/4: Checking /etc/fstab for UUID errors...${STD}"
    echo "----------------------------------------------------------------------"
    printf "${WHITE}%-20s | %-50s${STD}\n" "CONFIGURED DRIVES" "ACTUAL DRIVES (lsblk)"
    echo "----------------------------------------------------------------------"
    cat /etc/fstab 2>/dev/null | grep -E 'UUID|LABEL' | awk '{printf "%-20s | ", $1}'
    echo ""
    lsblk -f 2>/dev/null | grep -E "part|disk" | awk '{printf "                       | %s\n", $0}'
    echo "----------------------------------------------------------------------"
    pause
    lastmessage="${GREEN}Auto-Diagnostic complete.${STD}"
}

RunBootRepairGUI(){
    if ! command -v boot-repair &> /dev/null; then echo -e "${RED}Boot-Repair not installed.${STD}"; pause; return 1; fi
    echo -e "${CYAN}Launching Boot-Repair GUI...${STD}"
    boot-repair
    lastmessage="Launched Boot-Repair (GUI)."
}

GrubRescueCheatSheet(){
    clear
    echo -e "${RED}--- GRUB RESCUE CHEAT SHEET ---${STD}"
    echo "1. List drives: ls"
    echo "2. Find linux: ls (hd0,gpt2)/"
    echo "3. Set root: set root=(hd0,gpt2); set prefix=(hd0,gpt2)/boot/grub"
    echo "4. Boot: insmod normal; normal"
    pause
}

# --- NEW: GRAPHICS RESCUE FUNCTIONS ---

Graphics_Menu(){
    while true; do
        clear
        echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${STD}"
        echo -e "${RED}â•‘${STD} ${WHITE}GRAPHICS & DISPLAY REPAIR (HEADLESS/TTY MODE)${STD}                                              ${RED}â•‘${STD}"
        echo -e "${RED}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${STD}"
        echo " "
        echo -e " ${YELLOW}Use these tools if you have a BLACK SCREEN or LOGIN LOOP.${STD}"
        echo " "
        echo -e " ${CYAN}1.${STD} Auto-Install Recommended Drivers (ubuntu-drivers)"
        echo -e " ${CYAN}2.${STD} Purge NVIDIA Drivers (Fixes boot issues caused by bad updates)"
        echo -e " ${CYAN}3.${STD} Delete Xorg Config (Reset Display Settings)"
        echo -e " ${CYAN}4.${STD} Restart Display Manager (GDM/LightDM - Restart GUI)"
        echo -e " ${CYAN}5.${STD} Check Kernel Ring Buffer (dmesg - Look for GPU errors)"
        echo " "
        echo -e " ${RED}99. Return to Main Menu${STD}"
        echo " "
        read -r -p " Select Option: " g_choice
        
        case $g_choice in
            1) 
                echo -e "${GREEN}Running: sudo ubuntu-drivers autoinstall${STD}"
                sudo ubuntu-drivers autoinstall
                pause ;;
            2)
                echo -e "${RED}WARNING: This removes all NVIDIA packages. System will fallback to Nouveau.${STD}"
                read -r -p "Are you sure? (y/n): " confirm
                if [[ "$confirm" == "y" ]]; then
                    sudo apt purge '*nvidia*' -y
                    sudo apt autoremove -y
                    echo "Purge complete. Reboot recommended."
                    pause
                fi ;;
            3)
                echo -e "${YELLOW}Deleting /etc/X11/xorg.conf...${STD}"
                if [ -f /etc/X11/xorg.conf ]; then
                    sudo rm /etc/X11/xorg.conf
                    echo "Deleted. Reboot to auto-detect display."
                else
                    echo "File not found (This is usually good)."
                fi
                pause ;;
            4)
                echo -e "${RED}WARNING: This will kill your current graphical session!${STD}"
                read -r -p "Are you sure? (y/n): " confirm
                if [[ "$confirm" == "y" ]]; then
                    if systemctl is-active --quiet gdm; then sudo systemctl restart gdm; fi
                    if systemctl is-active --quiet lightdm; then sudo systemctl restart lightdm; fi
                    if systemctl is-active --quiet sddm; then sudo systemctl restart sddm; fi
                fi ;;
            5)
                dmesg | grep -iE "drm|nvidia|amdgpu|error|fail" | tail -n 20
                pause ;;
            99) return ;;
            *) ;;
        esac
    done
}

# -----------------------------------------------------------
# ðŸ¤– AI & DEVELOPMENT (Functions unchanged)
# -----------------------------------------------------------

Ollama_Setup(){
    echo -e "${CYAN}--- Ollama Installation ---${STD}"
    if ! command -v ollama &> /dev/null; then curl -fsSL https://ollama.com/install.sh | sh; fi
    
    echo -e "\n${MAGENTA}1. Standard Config  |  2. RX 570/Polaris Patch${STD}"
    read -r -p "Select Configuration [1/2]: " c
    if [[ "$c" == "2" ]]; then
        echo -e "${YELLOW}Enter path for models:${STD}"
        read -r -p "Path (Default: $MODEL_PATH): " USER_PATH
        [ -n "$USER_PATH" ] && MODEL_PATH=${USER_PATH%/}
        if [ ! -d "$MODEL_PATH" ]; then sudo mkdir -p "$MODEL_PATH"; fi

        sudo systemctl stop ollama
        sudo mkdir -p /etc/systemd/system/ollama.service.d
        echo "[Service]" | sudo tee "$OVERRIDE_FILE" >/dev/null
        echo "Environment=\"OLLAMA_MODELS=$MODEL_PATH\"" | sudo tee -a "$OVERRIDE_FILE" >/dev/null
        echo "Environment=\"HSA_OVERRIDE_GFX_VERSION=8.0.3\"" | sudo tee -a "$OVERRIDE_FILE" >/dev/null
        sudo usermod -aG render,video ollama
        sudo chown -R ollama:ollama "$MODEL_PATH"
        sudo systemctl daemon-reload && sudo systemctl start ollama
        lastmessage="Ollama configured for RX 570."
    else
        sudo systemctl start ollama
        lastmessage="Ollama installed (Standard Config)."
    fi
}

MonitorGPU(){
    if ! command -v radeontop &> /dev/null; then echo -e "${RED}radeontop missing.${STD}"; pause; return 1; fi
    sudo radeontop
    pause
}

InstallDocker(){
    $SAI docker.io docker-compose
    sudo usermod -aG docker "$USER"
    lastmessage="Docker installed. Relogin required."
}

# -----------------------------------------------------------
# ðŸ“¦ GENERIC PODMAN MANAGER FUNCTIONS (Abbreviated for length, logic same as v18)
# -----------------------------------------------------------

Setup(){ $SAI podman containers-storage podman-docker docker-compose; sudo systemctl enable --now podman.socket; pause; }
CreateNewProject(){ 
    read -rp "Project Name: " newproject; 
    mkdir -p "$HOME/container_projects/$newproject"; cd "$HOME/container_projects/$newproject" 2>/dev/null; 
    loadproject="$newproject"; lastmessage="Project created: $newproject"; 
}
LoadProject(){ 
    ls -d "$HOME/container_projects"/*/ 2>/dev/null | xargs -n 1 basename
    read -rp "Project Name: " loadproject; 
    cd "$HOME/container_projects/$loadproject" 2>/dev/null; lastmessage="Loaded: $loadproject"; 
}
NamePod(){ sudo podman pod list; read -rp "Name: " PodName; }  
CreatePod(){ sudo podman pod create --name "$PodName"; lastmessage="Pod '$PodName' created."; }
SelectContainer(){ sudo podman ps -a --pod; read -rp "Container Name: " containername; }
ChooseFile(){ ls "$HOME/container_projects/$loadproject/"*.yml 2>/dev/null; read -rp "File: " thisfile; }
RunCompose(){ cd "$HOME/container_projects/$loadproject" 2>/dev/null; sudo docker-compose -f "$thisfile" up; }
ComposeDown(){ cd "$HOME/container_projects/$loadproject" 2>/dev/null; sudo docker-compose -f "$thisfile" down; }
GetPodmanStats(){
    local R=$(sudo podman ps -q 2>/dev/null | wc -l); local I=$(sudo podman images -q 2>/dev/null | wc -l); local P=$(sudo podman pod list -q 2>/dev/null | wc -l)
    echo -e "${GREEN}Running: ${R:-0}${STD} | ${CYAN}Images: ${I:-0}${STD} | ${MAGENTA}Pods: ${P:-0}${STD}"
}

Podman_Menu(){
    local podman_lastmessage="Container: ${containername:-None} | Pod: ${PodName:-None}"
    while true; do
        clear
        echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${STD}"
        echo -e "${BLUE}â•‘${STD} ${WHITE}PODMAN CONTAINER MANAGER V19.0${STD}                                                         ${BLUE}â•‘${STD}"
        echo -e "${BLUE}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${STD}"
        printf "${BLUE}â•‘${STD} ${CYAN}%-14s${STD} : %-30s ${CYAN}%-14s${STD} : %-30s ${BLUE}â•‘${STD}\n" "Project Folder" "${loadproject:-None}" "Selected Pod" "${PodName:-None}"
        printf "${BLUE}â•‘${STD} ${CYAN}%-14s${STD} : %-30s ${CYAN}%-14s${STD} : %-30s ${BLUE}â•‘${STD}\n" "Container Name" "${containername:-None}" "Stats" "$(GetPodmanStats)"
        echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${STD}"
        echo ""
        echo " 1. Create/Load Project | 3. Name Pod | 4. Create Pod"
        echo " 10. Start Pod | 11. Stop Pod | 13. Select Container | 14. Remove Container | 15. Commit Image"
        echo " 20. List Pods | 21. List Images | 22. Inspect | 23. Logs | 25. Attach"
        echo " 30. Compose Up | 32. Compose Down"
        echo " 99. Back"
        echo "----------------------------------------------------------------------"
        read -r -p " Select: " choice
        case $choice in
            1) CreateNewProject ;; 2) LoadProject ;; 3) NamePod ;; 4) CreatePod ;;
            10) [ -n "$PodName" ] && sudo podman pod start "$PodName" ;;
            11) [ -n "$PodName" ] && sudo podman pod stop "$PodName" ;;
            13) SelectContainer ;; 14) [ -n "$containername" ] && sudo podman rm -f "$containername" ;; 15) sudo podman commit "$containername" "${containername}_img" ;;
            20) sudo podman ps -a --pod; pause ;; 21) sudo podman images; pause ;; 22) [ -n "$containername" ] && sudo podman inspect "$containername" | less ;; 23) [ -n "$containername" ] && sudo podman logs "$containername" | less ;;
            25) [ -n "$containername" ] && sudo podman attach "$containername" ;;
            30) ChooseFile && RunCompose ;; 32) ChooseFile && ComposeDown ;;
            99) return ;; *) ;;
        esac
    done
}

# -----------------------------------------------------------
# ðŸ“œ MAIN MENU LOOP
# -----------------------------------------------------------

ShowMenu(){
    DrawHeader
    echo ""
    echo -e " ${GREEN}:: 1. MAINTENANCE ::${STD}"
    echo -e "  ${WHITE}10.${STD} ${YELLOW}Install All Core Tools${STD} | ${WHITE}11.${STD} Update System | ${WHITE}13.${STD} Disk Analyzer | ${WHITE}14.${STD} Timeshift"

    echo -e "\n ${RED}:: 2. EMERGENCY RESCUE ROOM ::${STD}"
    echo -e "  ${WHITE}20.${STD} ${YELLOW}Auto-Diagnostic & Repair${STD}"
    echo -e "  ${WHITE}21.${STD} Run Boot-Repair (GUI)"
    echo -e "  ${WHITE}22.${STD} GRUB Rescue Cheatsheet"
    echo -e "  ${WHITE}23.${STD} Install TestDisk"
    echo -e "  ${WHITE}24.${STD} ${RED}GRAPHICS & DISPLAY REPAIR (Drivers/Xorg) [NEW]${STD}"
    
    echo -e "\n ${CYAN}:: 3. DEV & AI ::${STD}"
    echo -e "  ${WHITE}30.${STD} Install/Config Ollama (RX 570 Patch)"
    echo -e "  ${WHITE}31.${STD} ${MAGENTA}PODMAN MANAGER SUBMENU${STD}"
    echo -e "  ${WHITE}32.${STD} Install Docker"
    echo -e "  ${WHITE}33.${STD} Monitor GPU"
    
    echo -e "\n ${MAGENTA}:: 4. POWER ::${STD}"
    echo -e "  ${WHITE}80.${STD} Reboot | ${WHITE}99.${STD} Exit"
    
    echo " ----------------------------------------------------------------------------------------------------"
    echo -e "${YELLOW} $lastmessage${STD}"
    echo " ----------------------------------------------------------------------------------------------------"
    read -r -p "  Select Option: " choice
    
    lastmessage=""
    case $choice in
        10) InstallCoreTools ;; 11) SystemUpdates ;; 13) DiskAnalyzer ;; 14) SnapshotManager ;;
        20) GuidedRescue ;; 21) RunBootRepairGUI ;; 22) GrubRescueCheatSheet ;; 23) $SAI testdisk ;; 
        24) Graphics_Menu ;; # NEW SUBMENU
        30) Ollama_Setup ;; 31) Podman_Menu ;; 32) InstallDocker ;; 33) MonitorGPU ;;
        80) sudo reboot ;; 99) clear; exit 0 ;;
        *) lastmessage="${RED}Invalid Option: $choice${STD}" ;;
    esac
}

if ! command -v bc &> /dev/null; then sudo apt install -y bc > /dev/null 2>&1; fi
while true; do ShowMenu; done
EOF_SCRIPT
# --- END OF TOOL CODE ---

# Set Permissions
chmod +x "$TARGET_PATH"

echo -e "${GREEN}Installation complete!${STD}"
echo -e "Run the tool from any terminal (even TTY) by typing: ${CYAN}$SCRIPT_NAME${STD}"